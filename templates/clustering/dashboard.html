{% extends 'base.html' %}

{% block title %}RAM - ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨{% endblock %}

{% block content %}
<div class="col-12">
    <div class="main-content">
        
        <div class="page-header-3d fade-in-up">
            <h1>ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø°ÙƒÙŠ</h1>
            <p>Ø§ÙƒØªØ´Ù Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆØ¬Ù…Ø¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠØ©</p>
        </div>
        
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-sliders-h me-2"></i>Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ¬Ù…ÙŠØ¹</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-4">
                            <label class="form-label"><i class="fas fa-layer-group me-2"></i>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</label>
                            <select id="numClusters" class="form-control">
                                <option value="3">3 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                                <option value="4" selected>4 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                                <option value="5">5 Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</option>
                            </select>
                        </div>
                        <button id="performClustering" class="btn btn-primary w-100 btn-lg">
                            ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-chart-pie me-2"></i>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5>
                    </div>
                    <div class="card-body">
                        <div id="clusterStats" class="row">
                            <div class="col-12 text-center py-4">
                                <i class="fas fa-users text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row g-3 mb-3">
            
            <div class="col-lg-8">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-project-diagram me-2"></i>Ø®Ø±ÙŠØ·Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="clusterVisualization" style="height: 350px;">
                            <div class="text-center py-5">
                                <i class="fas fa-project-diagram text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="scoreDistribution" style="height: 350px;">
                            <div class="text-center py-5">
                                <i class="fas fa-chart-bar text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙˆØ²ÙŠØ¹</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row g-3 mb-3">
            
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-th me-2"></i>Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯</h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="correlationHeatmap" style="height: 300px;">
                            <div class="text-center py-5">
                                <i class="fas fa-th text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…ØµÙÙˆÙØ©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            
            <div class="col-lg-6">
                <div class="card h-100">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-users me-2"></i>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠ</h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="demographicAnalysis" style="height: 300px;">
                            <div class="text-center py-5">
                                <i class="fas fa-users text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row g-3 mb-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header py-2">
                        <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h6>
                    </div>
                    <div class="card-body p-2">
                        <div id="performanceComparison" style="height: 350px;">
                            <div class="text-center py-5">
                                <i class="fas fa-chart-line text-muted" style="font-size: 2rem;"></i>
                                <p class="text-muted mt-2 mb-0">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù‚Ø§Ø±Ù†Ø©</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h5>
                    </div>
                    <div class="card-body">
                        <div id="clusterDetails">
                            <p class="text-muted text-center">Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>â„¹ï¸ ÙƒÙŠÙ ÙŠØ¹Ù…Ù„ ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <h6>1. Ø¬Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
                                <p>Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…Ø®ØªÙ„ÙØ© ÙˆÙ…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</p>
                            </div>
                            <div class="col-md-3">
                                <h6>2. Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h6>
                                <p>ØªØ·Ø¨ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¶ÙŠØ±Ù‡Ø§ Ù„Ù„Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©</p>
                            </div>
                            <div class="col-md-3">
                                <h6>3. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© K-Means</h6>
                                <p>ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙÙŠ Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ù…ØªØ´Ø§Ø¨Ù‡Ø©</p>
                            </div>
                            <div class="col-md-3">
                                <h6>4. Ø§Ù„ØªØ­Ù„ÙŠÙ„</h6>
                                <p>ØªØ­Ù„ÙŠÙ„ Ø®ØµØ§Ø¦Øµ ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© ÙˆØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØªÙˆØµÙŠØ§Øª</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    $('#performClustering').click(function() {
        const btn = $(this);
        const numClusters = parseInt($('#numClusters').val());
        
        btn.prop('disabled', true).html('â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ¬Ù…ÙŠØ¹...');
        
        
        setTimeout(function() {
            const mockData = generateMockClusterData(numClusters);
            displayClusterResults(mockData);
            btn.prop('disabled', false).html('ğŸ” ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹');
        }, 2000); 
    });
    
    
    function generateMockClusterData(numClusters) {
        const clusterNames = ['Ø§Ù„Ù…ØªÙÙˆÙ‚ÙˆÙ†', 'Ø§Ù„Ø¬ÙŠØ¯ÙˆÙ†', 'Ø§Ù„Ù…ØªÙˆØ³Ø·ÙˆÙ†', 'ÙŠØ­ØªØ§Ø¬ÙˆÙ† Ø¯Ø¹Ù…', 'Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙˆÙ†'];
        const totalStudents = 1000;
        
        
        let clusterStats = [];
        let remainingStudents = totalStudents;
        
        for (let i = 0; i < numClusters; i++) {
            let studentCount;
            if (i === numClusters - 1) {
                studentCount = remainingStudents;
            } else {
                
                const baseCount = Math.floor(totalStudents / numClusters);
                const variation = Math.floor(baseCount * 0.3 * (Math.random() - 0.5));
                studentCount = baseCount + variation;
                remainingStudents -= studentCount;
            }
            
            clusterStats.push({
                cluster_name: clusterNames[i],
                student_count: Math.max(50, studentCount), 
                avg_math: 60 + Math.random() * 30 + (numClusters - i - 1) * 5,
                avg_reading: 65 + Math.random() * 25 + (numClusters - i - 1) * 5,
                avg_writing: 62 + Math.random() * 28 + (numClusters - i - 1) * 5
            });
        }
        
        
        const visualizationData = {
            x: [],
            y: [],
            cluster: []
        };
        
        for (let i = 0; i < numClusters; i++) {
            const clusterSize = clusterStats[i].student_count;
            for (let j = 0; j < Math.min(clusterSize, 100); j++) { 
                
                const centerX = (i % 2) * 50 + 25 + (Math.random() - 0.5) * 20;
                const centerY = Math.floor(i / 2) * 50 + 25 + (Math.random() - 0.5) * 20;
                
                visualizationData.x.push(centerX);
                visualizationData.y.push(centerY);
                visualizationData.cluster.push(i);
            }
        }
        
        return {
            cluster_stats: clusterStats,
            visualization_data: visualizationData,
            correlation_matrix: generateCorrelationMatrix(),
            demographic_data: generateDemographicData(numClusters)
        };
    }
    
    
    function generateCorrelationMatrix() {
        return {
            subjects: ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„ÙƒØªØ§Ø¨Ø©'],
            values: [
                [1.0, 0.75, 0.68],
                [0.75, 1.0, 0.82],
                [0.68, 0.82, 1.0]
            ]
        };
    }
    
    
    function generateDemographicData(numClusters) {
        return {
            gender_distribution: {
                male: 48 + Math.random() * 4,
                female: 52 - Math.random() * 4
            },
            parental_education: {
                'high_school': 25 + Math.random() * 10,
                'bachelor': 35 + Math.random() * 10,
                'master': 20 + Math.random() * 10,
                'other': 20 + Math.random() * 10
            }
        };
    }
    
    function displayClusterResults(data) {
        
        let statsHtml = '';
        const colors = ['#B85C57', '#28a745', '#ffc107', '#17a2b8', '#6f42c1'];
        
        data.cluster_stats.forEach(function(cluster, index) {
            statsHtml += `
                <div class="col-md-${12/data.cluster_stats.length} mb-3">
                    <div class="stats-card-3d fade-in-up" style="animation-delay: ${index * 0.1}s;">
                        <div class="stats-number-3d" style="color: ${colors[index]};">${cluster.student_count}</div>
                        <div class="stats-label-3d">${cluster.cluster_name}</div>
                        <div class="stats-details-3d">
                            <small style="color: #6c757d;">
                                Ø±ÙŠØ§Ø¶ÙŠØ§Øª: ${cluster.avg_math.toFixed(1)} | 
                                Ù‚Ø±Ø§Ø¡Ø©: ${cluster.avg_reading.toFixed(1)} | 
                                ÙƒØªØ§Ø¨Ø©: ${cluster.avg_writing.toFixed(1)}
                            </small>
                        </div>
                    </div>
                </div>
            `;
        });
        
        $('#clusterStats').html(statsHtml);
        
        
        window.lastClusterResults = data;
        window.lastClusterColors = colors;
        
        
        createClusterVisualization(data, colors);
        
        
        createSimpleScoreDistribution(data, colors);
        
        
        createSimpleCorrelationHeatmap(data);
        
        
        createSimpleDemographicAnalysis(data);
        
        
        createSimplePerformanceComparison(data, colors);
        
        
        displaySimpleClusterDetails(data, colors);
    }
    
    function createClusterVisualization(data, colors) {
        try {
            const trace = {
                x: data.visualization_data.x,
                y: data.visualization_data.y,
                mode: 'markers',
                type: 'scatter',
                marker: {
                    color: data.visualization_data.cluster.map(c => colors[c]),
                    size: 8,
                    line: {
                        color: '#FFFFFF',
                        width: 1
                    },
                    opacity: 0.7
                },
                text: data.visualization_data.cluster.map((c, i) => 
                    `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©: ${data.cluster_stats[c].cluster_name}<br>` +
                    `Ø§Ù„Ù†Ù‚Ø·Ø©: ${i + 1}`
                ),
                hovertemplate: '%{text}<extra></extra>'
            };
        
        const layout = {
            title: {
                text: 'Ø®Ø±ÙŠØ·Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ (ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)',
                font: { family: 'Cairo', size: 16, color: '#2C2C2C' },
                x: 0.5
            },
            xaxis: { 
                title: { text: 'Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø£ÙˆÙ„', font: { family: 'Cairo', size: 12 } },
                gridcolor: '#F5F1ED',
                font: { family: 'Cairo', size: 10 }
            },
            yaxis: { 
                title: { text: 'Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø«Ø§Ù†ÙŠ', font: { family: 'Cairo', size: 12 } },
                gridcolor: '#F5F1ED',
                font: { family: 'Cairo', size: 10 }
            },
            plot_bgcolor: '#FFFFFF',
            paper_bgcolor: '#FFFFFF',
            showlegend: false,
            margin: { t: 50, b: 50, l: 50, r: 50 }
        };
        
        Plotly.newPlot('clusterVisualization', [trace], layout, {responsive: true, displayModeBar: false});
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹:', error);
            $('#clusterVisualization').html(`
                <div class="alert alert-info text-center m-2">
                    <i class="fas fa-project-diagram me-2"></i>
                    <strong>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¬Ù…ÙŠØ¹</strong><br>
                    <small>ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ ${data.cluster_stats.length} Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¨Ù†Ø¬Ø§Ø­</small>
                </div>
            `);
        }
    }
    
    function createScoreDistribution(data, colors) {
        const subjects = ['math score', 'reading score', 'writing score'];
        const arabicSubjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„ÙƒØªØ§Ø¨Ø©'];
        
        const traces = subjects.map((subject, index) => ({
            y: data.cluster_stats.map(cluster => cluster[`avg_${subject.replace(' ', '_')}`]),
            x: data.cluster_stats.map(cluster => cluster.cluster_name),
            name: arabicSubjects[index],
            type: 'bar',
            marker: { color: colors[index] }
        }));
        
        const layout = {
            title: {
                text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©',
                font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                x: 0.5
            },
            xaxis: { 
                title: { text: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª', font: { family: 'Cairo', size: 10 } },
                font: { family: 'Cairo', size: 9 }
            },
            yaxis: { 
                title: { text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©', font: { family: 'Cairo', size: 10 } },
                font: { family: 'Cairo', size: 9 }
            },
            plot_bgcolor: '#FFFFFF',
            paper_bgcolor: '#FFFFFF',
            legend: { font: { family: 'Cairo', size: 9 } },
            margin: { t: 40, b: 60, l: 50, r: 20 }
        };
        
        Plotly.newPlot('scoreDistribution', traces, layout, {responsive: true, displayModeBar: false});
    }
    
    function createCorrelationHeatmap(data) {
        if (!data.correlation_data) return;
        
        const subjects = ['math score', 'reading score', 'writing score'];
        const arabicSubjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„ÙƒØªØ§Ø¨Ø©'];
        const correlationMatrix = data.correlation_data.correlation_matrix;
        
        const z = subjects.map(subject1 => 
            subjects.map(subject2 => correlationMatrix[subject1][subject2])
        );
        
        
        const annotations = [];
        for (let i = 0; i < subjects.length; i++) {
            for (let j = 0; j < subjects.length; j++) {
                const value = z[i][j];
                const textColor = value > 0.5 ? 'white' : 'black';
                
                annotations.push({
                    x: arabicSubjects[j],
                    y: arabicSubjects[i],
                    text: value.toFixed(3),
                    showarrow: false,
                    font: {
                        color: textColor,
                        size: 14,
                        family: 'Cairo'
                    }
                });
            }
        }
        
        const trace = {
            z: z,
            x: arabicSubjects,
            y: arabicSubjects,
            type: 'heatmap',
            colorscale: [
                [0, '#F5F1ED'],
                [0.3, '#E8D5D1'],
                [0.6, '#B85C57'],
                [1, '#A04A45']
            ],
            showscale: true,
            colorbar: {
                title: {
                    text: 'Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·',
                    font: { family: 'Cairo', size: 10 }
                },
                titleside: 'right'
            },
            hoverongaps: false,
            hovertemplate: '<b>%{y} Ã— %{x}</b><br>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·: %{z:.3f}<extra></extra>'
        };
        
        const layout = {
            title: {
                text: 'Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©',
                font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                x: 0.5
            },
            xaxis: { 
                font: { family: 'Cairo', size: 10 },
                side: 'bottom',
                tickangle: 0
            },
            yaxis: { 
                font: { family: 'Cairo', size: 10 },
                autorange: 'reversed'
            },
            plot_bgcolor: '#FFFFFF',
            paper_bgcolor: '#FFFFFF',
            margin: { t: 40, b: 50, l: 80, r: 80 },
            annotations: annotations
        };
        
        Plotly.newPlot('correlationHeatmap', [trace], layout, {responsive: true, displayModeBar: false});
    }
    
    function createDemographicAnalysis(data) {
        if (!data.demographic_data) return;
        
        
        const genderData = data.demographic_data.gender || {};
        const genderLabels = Object.keys(genderData).map(key => 
            key === 'male' ? 'Ø°ÙƒØ±' : key === 'female' ? 'Ø£Ù†Ø«Ù‰' : key
        );
        
        const trace = {
            values: Object.values(genderData),
            labels: genderLabels,
            type: 'pie',
            marker: {
                colors: ['#B85C57', '#28a745']
            },
            textinfo: 'label+percent',
            textfont: { family: 'Cairo', size: 10 }
        };
        
        const layout = {
            title: {
                text: 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³',
                font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                x: 0.5
            },
            plot_bgcolor: '#FFFFFF',
            paper_bgcolor: '#FFFFFF',
            margin: { t: 40, b: 20, l: 20, r: 20 },
            showlegend: true,
            legend: { font: { family: 'Cairo', size: 9 } }
        };
        
        Plotly.newPlot('demographicAnalysis', [trace], layout, {responsive: true, displayModeBar: false});
    }
    
    function createPerformanceComparison(data, colors) {
        const clusterNames = data.cluster_stats.map(cluster => cluster.cluster_name);
        const mathScores = data.cluster_stats.map(cluster => cluster.avg_math_score);
        const readingScores = data.cluster_stats.map(cluster => cluster.avg_reading_score);
        const writingScores = data.cluster_stats.map(cluster => cluster.avg_writing_score);
        
        const traces = [
            {
                x: clusterNames,
                y: mathScores,
                name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#B85C57', width: 3 },
                marker: { size: 8 }
            },
            {
                x: clusterNames,
                y: readingScores,
                name: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#28a745', width: 3 },
                marker: { size: 8 }
            },
            {
                x: clusterNames,
                y: writingScores,
                name: 'Ø§Ù„ÙƒØªØ§Ø¨Ø©',
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#ffc107', width: 3 },
                marker: { size: 8 }
            }
        ];
        
        const layout = {
            title: {
                text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠ Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
                font: { family: 'Cairo', size: 16, color: '#2C2C2C' },
                x: 0.5
            },
            xaxis: { 
                title: { text: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª', font: { family: 'Cairo', size: 12 } },
                font: { family: 'Cairo', size: 10 }
            },
            yaxis: { 
                title: { text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø©', font: { family: 'Cairo', size: 12 } },
                font: { family: 'Cairo', size: 10 },
                range: [0, 100]
            },
            plot_bgcolor: '#FFFFFF',
            paper_bgcolor: '#FFFFFF',
            legend: { 
                font: { family: 'Cairo', size: 10 },
                orientation: 'h',
                x: 0.5,
                xanchor: 'center',
                y: -0.2
            },
            margin: { t: 50, b: 80, l: 60, r: 40 }
        };
        
        Plotly.newPlot('performanceComparison', traces, layout, {responsive: true, displayModeBar: false});
    }
    
    function displayClusterDetails(data, colors) {
        let detailsHtml = '<div class="row">';
        data.cluster_stats.forEach(function(cluster, index) {
            const totalAvg = ((cluster.avg_math_score + cluster.avg_reading_score + cluster.avg_writing_score) / 3).toFixed(1);
            
            detailsHtml += `
                <div class="col-lg-6 mb-4">
                    <div class="card border-0 shadow-sm cluster-details-card">
                        <div class="card-header" style="background: linear-gradient(135deg, ${colors[index]} 0%, ${colors[index]}CC 100%); color: white; direction: rtl; text-align: right;">
                            <h6 class="mb-0"><i class="fas fa-users me-2"></i>${cluster.cluster_name}</h6>
                        </div>
                        <div class="card-body cluster-card-body">
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-0" style="color: ${colors[index]};">${cluster.student_count}</div>
                                        <small class="text-muted">Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="text-center">
                                        <div class="h4 mb-0" style="color: ${colors[index]};">${totalAvg}</div>
                                        <small class="text-muted">Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3" style="direction: rtl; text-align: right;">
                                <h6 class="text-primary mb-2">Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:</h6>
                                <div class="row">
                                    <div class="col-4 text-center">
                                        <div class="small text-muted">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</div>
                                        <div class="fw-bold">${cluster.avg_math_score.toFixed(1)}</div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="small text-muted">Ù‚Ø±Ø§Ø¡Ø©</div>
                                        <div class="fw-bold">${cluster.avg_reading_score.toFixed(1)}</div>
                                    </div>
                                    <div class="col-4 text-center">
                                        <div class="small text-muted">ÙƒØªØ§Ø¨Ø©</div>
                                        <div class="fw-bold">${cluster.avg_writing_score.toFixed(1)}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="cluster-recommendation">
                                <div style="font-weight: bold; margin-bottom: 5px; color: #B85C57;">Ø§Ù„ØªÙˆØµÙŠØ©:</div>
                                <div class="cluster-description">
                                    ${cluster.description}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
        detailsHtml += '</div>';
        $('#clusterDetails').html(detailsHtml);
    }
    
    
    function createSimpleScoreDistribution(data, colors) {
        try {
            const subjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„ÙƒØªØ§Ø¨Ø©'];
            
            const traces = data.cluster_stats.map((cluster, index) => ({
                x: subjects,
                y: [cluster.avg_math, cluster.avg_reading, cluster.avg_writing],
                type: 'bar',
                name: cluster.cluster_name,
                marker: { 
                    color: colors[index],
                    line: { color: '#FFFFFF', width: 2 },
                    opacity: 0.8
                },
                text: [cluster.avg_math.toFixed(1), cluster.avg_reading.toFixed(1), cluster.avg_writing.toFixed(1)],
                textposition: 'auto',
                textfont: { color: 'white', size: 11, family: 'Cairo', weight: 'bold' },
                hovertemplate: '<b>%{fullData.name}</b><br>%{x}: %{y:.1f}<br><extra></extra>'
            }));
            
            const layout = {
                title: {
                    text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ù„ÙƒÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø©',
                    font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                    x: 0.5
                },
                xaxis: { 
                    title: { text: 'Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 }
                },
                yaxis: { 
                    title: { text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 },
                    range: [0, 100]
                },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                margin: { t: 40, b: 50, l: 40, r: 20 },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.2,
                    font: { family: 'Cairo', size: 8 }
                },
                barmode: 'group'
            };
            
            Plotly.newPlot('scoreDistribution', traces, layout, {responsive: true, displayModeBar: false});
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª:', error);
            $('#scoreDistribution').html('<div class="alert alert-info text-center m-2"><i class="fas fa-chart-bar me-2"></i>Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ù„Ù„Ø¯Ø±Ø¬Ø§Øª</div>');
        }
    }
    
    function createSimpleCorrelationHeatmap(data) {
        try {
            const correlationMatrix = data.correlation_matrix;
            
            const trace = {
                z: correlationMatrix.values,
                x: correlationMatrix.subjects,
                y: correlationMatrix.subjects,
                type: 'heatmap',
                colorscale: [
                    [0, '#ffffff'],
                    [0.2, '#e8f4fd'],
                    [0.4, '#b3d9f2'],
                    [0.6, '#7cc7e8'],
                    [0.8, '#42a5cc'],
                    [1, '#1f77b4']
                ],
                showscale: true,
                colorbar: {
                    title: {
                        text: 'Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·',
                        font: { family: 'Cairo', size: 10 }
                    },
                    titleside: 'right'
                },
                text: correlationMatrix.values.map(row => 
                    row.map(val => val.toFixed(2))
                ),
                texttemplate: '<b>%{text}</b>',
                textfont: { 
                    size: 16, 
                    family: 'Cairo', 
                    color: '#000000'
                },
                hovertemplate: '<b>%{y} â†” %{x}</b><br>Ù…Ø¹Ø§Ù…Ù„ Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·: %{z:.3f}<extra></extra>'
            };
            
            const layout = {
                title: {
                    text: 'Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø· Ø¨ÙŠÙ† Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©',
                    font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                    x: 0.5
                },
                xaxis: { 
                    title: '', 
                    font: { family: 'Cairo', size: 11, color: '#2C2C2C' },
                    side: 'bottom',
                    tickangle: 0
                },
                yaxis: { 
                    title: '', 
                    font: { family: 'Cairo', size: 11, color: '#2C2C2C' },
                    autorange: 'reversed'
                },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                margin: { t: 40, b: 50, l: 80, r: 80 },
                width: null,
                height: null
            };
            
            Plotly.newPlot('correlationHeatmap', [trace], layout, {responsive: true, displayModeBar: false});
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ù… Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·:', error);
            $('#correlationHeatmap').html('<div class="alert alert-info text-center m-2"><i class="fas fa-th me-2"></i>Ù…ØµÙÙˆÙØ© Ø§Ù„Ø§Ø±ØªØ¨Ø§Ø·</div>');
        }
    }
    
    function createSimpleDemographicAnalysis(data) {
        try {
            const genderData = data.demographic_data.gender_distribution;
            
            const trace = {
                labels: ['Ø°ÙƒÙˆØ±', 'Ø¥Ù†Ø§Ø«'],
                values: [genderData.male, genderData.female],
                type: 'pie',
                marker: {
                    colors: ['#4A90E2', '#F5A623'],
                    line: { color: '#FFFFFF', width: 3 }
                },
                textinfo: 'label+percent+value',
                textfont: { family: 'Cairo', size: 11, weight: 'bold' },
                hovertemplate: '<b>%{label}</b><br>Ø§Ù„Ù†Ø³Ø¨Ø©: %{percent}<br>Ø§Ù„Ø¹Ø¯Ø¯: %{value:.0f}<extra></extra>',
                hole: 0.4
            };
            
            const layout = {
                title: {
                    text: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ù†Ø³',
                    font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                    x: 0.5
                },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                margin: { t: 40, b: 20, l: 20, r: 20 },
                showlegend: true,
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.1,
                    font: { family: 'Cairo', size: 9 }
                },
                annotations: [{
                    text: 'Ø§Ù„ØªÙˆØ²ÙŠØ¹<br>Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠ',
                    x: 0.5, y: 0.5,
                    font: { family: 'Cairo', size: 12, weight: 'bold', color: '#2C2C2C' },
                    showarrow: false
                }]
            };
            
            Plotly.newPlot('demographicAnalysis', [trace], layout, {responsive: true, displayModeBar: false});
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠ:', error);
            $('#demographicAnalysis').html('<div class="alert alert-info text-center m-2"><i class="fas fa-users me-2"></i>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¯ÙŠÙ…ÙˆØºØ±Ø§ÙÙŠ</div>');
        }
    }
    
    function createSimplePerformanceComparison(data, colors) {
        try {
            const clusterNames = data.cluster_stats.map(c => c.cluster_name);
            
            const traces = [
                {
                    x: clusterNames,
                    y: data.cluster_stats.map(c => c.avg_math),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª',
                    line: { color: '#B85C57', width: 3 },
                    marker: { size: 8, color: '#B85C57' },
                    hovertemplate: '<b>Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª</b><br>%{x}: %{y:.1f}<extra></extra>'
                },
                {
                    x: clusterNames,
                    y: data.cluster_stats.map(c => c.avg_reading),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©',
                    line: { color: '#28a745', width: 3 },
                    marker: { size: 8, color: '#28a745' },
                    hovertemplate: '<b>Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</b><br>%{x}: %{y:.1f}<extra></extra>'
                },
                {
                    x: clusterNames,
                    y: data.cluster_stats.map(c => c.avg_writing),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Ø§Ù„ÙƒØªØ§Ø¨Ø©',
                    line: { color: '#ffc107', width: 3 },
                    marker: { size: 8, color: '#ffc107' },
                    hovertemplate: '<b>Ø§Ù„ÙƒØªØ§Ø¨Ø©</b><br>%{x}: %{y:.1f}<extra></extra>'
                }
            ];
            
            const layout = {
                title: {
                    text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª Ø¹Ø¨Ø± Ø§Ù„Ù…ÙˆØ§Ø¯',
                    font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                    x: 0.5
                },
                xaxis: { 
                    title: { text: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 }
                },
                yaxis: { 
                    title: { text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 },
                    range: [0, 100]
                },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                margin: { t: 40, b: 60, l: 50, r: 30 },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.15,
                    font: { family: 'Cairo', size: 9 }
                }
            };
            
            Plotly.newPlot('performanceComparison', traces, layout, {responsive: true, displayModeBar: false});
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø±Ø³Ù… Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡:', error);
            $('#performanceComparison').html('<div class="alert alert-info text-center m-2"><i class="fas fa-chart-line me-2"></i>Ù…Ù‚Ø§Ø±Ù†Ø© Ø§Ù„Ø£Ø¯Ø§Ø¡</div>');
        }
    }
    
    function displaySimpleClusterDetails(data, colors) {
        $('#clusterDetailsSection').fadeIn(500);
        
        try {
            
            const subjects = ['Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ§Øª', 'Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©', 'Ø§Ù„ÙƒØªØ§Ø¨Ø©'];
            
            const traces = subjects.map((subject, subjectIndex) => {
                const subjectKey = ['avg_math', 'avg_reading', 'avg_writing'][subjectIndex];
                const subjectColors = ['#B85C57', '#28a745', '#ffc107'][subjectIndex];
                
                return {
                    x: data.cluster_stats.map(c => c.cluster_name),
                    y: data.cluster_stats.map(c => c[subjectKey]),
                    type: 'bar',
                    name: subject,
                    marker: { 
                        color: subjectColors,
                        opacity: 0.8,
                        line: { color: '#FFFFFF', width: 1 }
                    },
                    text: data.cluster_stats.map(c => c[subjectKey].toFixed(1)),
                    textposition: 'auto',
                    textfont: { color: 'white', size: 10, family: 'Cairo', weight: 'bold' },
                    hovertemplate: '<b>%{fullData.name}</b><br>%{x}: %{y:.1f}<br><extra></extra>'
                };
            });
            
            const layout = {
                title: {
                    text: 'Ù…Ù‚Ø§Ø±Ù†Ø© ØªÙØµÙŠÙ„ÙŠØ© Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª',
                    font: { family: 'Cairo', size: 14, color: '#2C2C2C' },
                    x: 0.5
                },
                xaxis: { 
                    title: { text: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 }
                },
                yaxis: { 
                    title: { text: 'Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¯Ø±Ø¬Ø§Øª', font: { family: 'Cairo', size: 10 } },
                    font: { family: 'Cairo', size: 9 },
                    range: [0, 100]
                },
                plot_bgcolor: '#FFFFFF',
                paper_bgcolor: '#FFFFFF',
                margin: { t: 50, b: 80, l: 50, r: 30 },
                legend: {
                    orientation: 'h',
                    x: 0.5,
                    xanchor: 'center',
                    y: -0.15,
                    font: { family: 'Cairo', size: 9 }
                },
                barmode: 'group'
            };
            
            Plotly.newPlot('clusterDetails', traces, layout, {responsive: true, displayModeBar: false});
            
            setTimeout(() => {
                let summaryHtml = '<div class="cluster-summary mt-3">';
                summaryHtml += '<h6 class="text-center mb-3" style="color: #2C2C2C;">ğŸ“Š Ù…Ù„Ø®Øµ Ø¥Ø­ØµØ§Ø¦ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</h6>';
                summaryHtml += '<div class="row g-2">';
                
                data.cluster_stats.forEach((cluster, index) => {
                    const avgTotal = (cluster.avg_math + cluster.avg_reading + cluster.avg_writing) / 3;
                    const performance = avgTotal >= 80 ? 'Ù…Ù…ØªØ§Ø² ğŸ†' : avgTotal >= 70 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹ â­' : avgTotal >= 60 ? 'Ø¬ÙŠØ¯ ğŸ‘' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ† ğŸ“ˆ';
                    const performanceColor = avgTotal >= 80 ? '#28a745' : avgTotal >= 70 ? '#17a2b8' : avgTotal >= 60 ? '#ffc107' : '#dc3545';
                    
                    summaryHtml += `
                        <div class="col-md-3 col-6">
                            <div class="summary-card" style="border-top: 4px solid ${colors[index]};">
                                <div class="summary-title" style="color: ${colors[index]};">${cluster.cluster_name}</div>
                                <div class="summary-count">${cluster.student_count} Ø·Ø§Ù„Ø¨</div>
                                <div class="summary-avg" style="color: ${performanceColor};">${avgTotal.toFixed(1)}</div>
                                <div class="summary-performance" style="color: ${performanceColor}; font-size: 0.8rem; margin-top: 5px;">
                                    ${performance}
                                </div>
                                <div class="summary-breakdown" style="font-size: 0.7rem; color: #6c757d; margin-top: 8px;">
                                    ğŸ“Š ${cluster.avg_math.toFixed(1)} | ğŸ“š ${cluster.avg_reading.toFixed(1)} | âœï¸ ${cluster.avg_writing.toFixed(1)}
                                </div>
                            </div>
                        </div>
                    `;
                });
                summaryHtml += '</div></div>';
                $('#clusterDetails').append(summaryHtml);
            }, 800);
            
        } catch (error) {
            console.error('Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª:', error);
            
            
            let html = '<div class="alert alert-info text-center mb-3">';
            html += '<i class="fas fa-chart-bar me-2"></i>';
            html += '<strong>ØªØ­Ù„ÙŠÙ„ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø§Øª</strong>';
            html += '</div>';
            
            html += '<div class="row g-3">';
            data.cluster_stats.forEach((cluster, index) => {
                const avgTotal = (cluster.avg_math + cluster.avg_reading + cluster.avg_writing) / 3;
                const performance = avgTotal >= 80 ? 'Ù…Ù…ØªØ§Ø²' : avgTotal >= 70 ? 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' : avgTotal >= 60 ? 'Ø¬ÙŠØ¯' : 'ÙŠØ­ØªØ§Ø¬ ØªØ­Ø³ÙŠÙ†';
                const performanceColor = avgTotal >= 80 ? '#28a745' : avgTotal >= 70 ? '#17a2b8' : avgTotal >= 60 ? '#ffc107' : '#dc3545';
                
                html += `
                    <div class="col-md-6 col-lg-3">
                        <div class="cluster-card-enhanced" style="border-left: 5px solid ${colors[index]}; background: linear-gradient(135deg, ${colors[index]}11, ${colors[index]}22);">
                            <div class="cluster-header-enhanced" style="background: ${colors[index]}33; color: ${colors[index]};">
                                <h6 class="mb-0">${cluster.cluster_name}</h6>
                                <span class="badge" style="background: ${colors[index]};">${cluster.student_count} Ø·Ø§Ù„Ø¨</span>
                            </div>
                            <div class="cluster-body-enhanced">
                                <div class="score-grid">
                                    <div class="score-item">
                                        <span class="score-icon">ğŸ“Š</span>
                                        <span class="score-label">Ø±ÙŠØ§Ø¶ÙŠØ§Øª</span>
                                        <span class="score-value" style="color: #B85C57;">${cluster.avg_math.toFixed(1)}</span>
                                    </div>
                                    <div class="score-item">
                                        <span class="score-icon">ğŸ“š</span>
                                        <span class="score-label">Ù‚Ø±Ø§Ø¡Ø©</span>
                                        <span class="score-value" style="color: #28a745;">${cluster.avg_reading.toFixed(1)}</span>
                                    </div>
                                    <div class="score-item">
                                        <span class="score-icon">âœï¸</span>
                                        <span class="score-label">ÙƒØªØ§Ø¨Ø©</span>
                                        <span class="score-value" style="color: #ffc107;">${cluster.avg_writing.toFixed(1)}</span>
                                    </div>
                                </div>
                                <div class="total-score" style="background: ${performanceColor}22; color: ${performanceColor};">
                                    <strong>Ø§Ù„Ù…ØªÙˆØ³Ø· Ø§Ù„Ø¹Ø§Ù…: ${avgTotal.toFixed(1)}</strong>
                                    <div style="font-size: 0.8rem; margin-top: 4px;">${performance}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            $('#clusterDetails').html(html);
        }
    }
    
    
    function restoreClusterResults() {
        if (window.lastClusterResults && window.lastClusterColors) {
            console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ØªØ¬Ù…ÙŠØ¹...');
            displayClusterResults(window.lastClusterResults);
        }
    }
    
    
    setInterval(function() {
        const statsContent = $('#clusterStats').html();
        if (statsContent && statsContent.includes('Ù‚Ù… Ø¨ØªÙ†ÙÙŠØ° Ø§Ù„ØªØ¬Ù…ÙŠØ¹') && window.lastClusterResults) {
            console.log('âš ï¸ ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø§Ø®ØªÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©...');
            restoreClusterResults();
        }
    }, 2000);
    
    
    $(window).on('beforeunload', function() {
        if (window.lastClusterResults) {
            localStorage.setItem('clusterResults', JSON.stringify(window.lastClusterResults));
            localStorage.setItem('clusterColors', JSON.stringify(window.lastClusterColors));
        }
    });
    
    
    $(document).ready(function() {
        const savedResults = localStorage.getItem('clusterResults');
        const savedColors = localStorage.getItem('clusterColors');
        
        if (savedResults && savedColors) {
            window.lastClusterResults = JSON.parse(savedResults);
            window.lastClusterColors = JSON.parse(savedColors);
            
            setTimeout(function() {
                console.log('ğŸ“‚ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©...');
                displayClusterResults(window.lastClusterResults);
            }, 1000);
        }
    });
});
</script>
{% endblock %}